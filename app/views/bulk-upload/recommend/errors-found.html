{% extends "_templates/_page.html" %}

{% set navActive = 'bulk' %}

{% set filteredRecords = data.records | filterRecords(data) %}
{% set currentTrainees = filteredRecords | filterByStatus("Draft", true) | filterByActive %}

{% set traineesThatCanBeRecommended = currentTrainees | filterByComplete | filterByStatus(["Deferred", "Withdrawn", "QTS recommended", "QTS awarded", "EYTS recommended", "EYTS awarded"], true) %}

{% set errorTrainees     = [] %}
{% set unchangedTrainees =  0 %}
{% set updatedTrainees   =  0 %}

{% for trainee in traineesThatCanBeRecommended %}

  {% set traineeRecord = null %}

  {% set randomNumber = range(0, 100) | random %}

  {% if randomNumber <= 8 %}
    {% set traineeRecord = "error" %}
  {% elseif randomNumber > 8 and randomNumber <= 12 %}
    {% set unchangedTrainees = unchangedTrainees + 1 %}
  {% elseif randomNumber > 12 %}
    {% set updatedTrainees = updatedTrainees + 1 %}
  {% endif %}

  {% if traineeRecord == "error" %}
    {% set errorMessage = [
      'TRN not recognised',
      'TRN missing',
      'Date standards met: ‘07/20/2023’, enter a valid start date',
      'Date standards met: ‘20/07/2023’, trainee start date must be in the past',
      'Postgraduate qualification: ‘BA (Hons)’, enter ‘PGCE’, ‘PGDE’ or ‘None’ for postgraduate qualification',
      'Postgraduate qualification: ‘PCGE’, trainees on undergraduate courses cannot be awarded a postgraduate qualification.',
      'Postgraduate qualification missing. If the trainee did not get a postgraduate qualification enter ‘None’.'
      ] | random
    %}

    {% set traineeInfo = trainee.personalDetails.shortName + '<br> <span style="color:  #505a5f">' + trainee.reference + '</span>' %}

    {% set row = [{text: loop.index + 2 }] %}
    {% if errorMessage == 'TRN not recognised.' %}
      {% set traineeInfo = trainee.reference %}
      {% set errorMessage = 'TRN: ‘' + trainee.reference + '’, enter a valid TRN' %}
    {% elseif errorMessage == 'TRN missing' %}
      {% set traineeInfo = '–' %}
    {% elseif errorMessage == 'URN not recognised' %}
      {% set errorMessage = "Placement 1 URN: ‘" + schoolName +  "’, enter a valid URN" %}
    {% elseif errorMessage == 'School is closed' %}
      {% set errorMessage = "Placement 1 URN: ‘" + range(10000, 20000) | random +  "’, this school is closed" %}
    {% endif %}
    
    {% set row = row | push({ text: traineeInfo | safe }) %}
    {% set row = row | push({ text: errorMessage | safe }) %}

    {% set errorTrainees = errorTrainees | push(row) %}

  {% endif %}
{% endfor %}

{# These counts are used by include "_includes/bulk-upload/upload-summary.html  #}
{% set errorCount = errorTrainees.length %}
{% set unchangedCount = unchangedTrainees %}
{% set updatedCount = updatedTrainees %}

{% set pageHeading = "Errors in your trainee records file" %}

{% set bulkPath = "recommend" %}
{% set bulkRoute = "recommend" %}

{% block content %}

  {% include "_includes/bulk-upload/errors-found.html" %}

{% endblock %}


