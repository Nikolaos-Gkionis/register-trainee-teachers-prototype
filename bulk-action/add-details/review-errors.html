{% extends "_templates/_page.html" %}

{% set navActive = 'bulk' %}

{% set currentTrainees = data.filteredRecords | filterByStatus("Draft", true) | filterByActive %}

{% set traineesThatCanBeUpdated = currentTrainees | filterByIncomplete | filterOutEarlyYears | filterByStatus(["Deferred", "Withdrawn"], true) %}
{% set traineesThatCannotBeUpdatedCount = (currentTrainees | filterByIncomplete | length) - (traineesThatCanBeUpdated | length ) %}

{% set tableBodyRows     = [] %}
{% set unchangedTrainees =  0 %}
{% set updatedTrainees   =  0 %}

{% for trainee in traineesThatCanBeUpdated %}

  {% set traineeRecord = null %}

  {% set randomNumber = range(0, 100) | random %}

  {% if randomNumber <= 8 %}
    {% set traineeRecord = "error" %}
  {% elseif randomNumber > 8 and randomNumber <= 12 %}
    {% set unchangedTrainees = unchangedTrainees + 1 %}
  {% elseif randomNumber > 12 %}
    {% set updatedTrainees = updatedTrainees + 1 %}
  {% endif %}

  {% if traineeRecord == "error" %}
    {% set errorMessage = [
      'TRN not recognised',
      'TRN missing',
      'Trainee start date: ‘07/20/2023’, enter a valid start date',
      'Trainee start date: ‘20/07/2023’, trainee start date must be in the past',
      'URN not recognised',
      'School is closed'
      ] | random
    %}

    {% set schoolName = [
      "Stratford Academy",
      "Stratford School",
      "St Peter and St Paul Infant School",
      "All Saints Catholic Middle School",
      "St Andrew’s Catholic School",
      "Sapel Heath Sixth Form College",
      "All Saints Catholic School",
      "Manor Academy",
      "St John's Primary School",
      "St Clement’s Church of England Middle School",
      "Cherry Primary School",
      "St John's Church of England School",
      "Saterton Academy",
      "Langley Tuition Centre",
      "Wattervea (Riarth Barborton College)",
      "Langley College",
      "St Peter’s Catholic School",
      "St Thomas’s Catholic Primary School",
      "New Primary School",
      "Church Hill High School",
      "Abbey Secondary School",
      "Langley College",
      "North East Academy",
      "Spockhope High School",
      "St Peter and St Paul Catholic Infant School",
      "Langley High School",
      "Somelcomwo's Tommon Primary School",
      "Cherry Academy"
    ] | random %}

    {% set traineeInfo = trainee.personalDetails.shortName + '<br> <span style="color:  #505a5f">' + trainee.reference + '</span>' %}

    {% set row = [{text: loop.index + 2 }] %}
    {% if errorMessage == 'TRN not recognised.' %}
      {% set traineeInfo = trainee.reference %}
      {% set errorMessage = 'TRN: ‘' + trainee.reference + '’, enter a valid TRN' %}
    {% elseif errorMessage == 'TRN missing' %}
      {% set traineeInfo = '–' %}
    {% elseif errorMessage == 'URN not recognised' %}
      {% set errorMessage = "Placement 1 URN: ‘" + schoolName +  "’, enter a valid URN" %}
    {% elseif errorMessage == 'School is closed' %}
      {% set errorMessage = "Placement 1 URN: ‘" + range(10000, 20000) | random +  "’, this school is closed" %}
    {% endif %}
    
    {% set row = row | push({ text: traineeInfo | safe }) %}
    {% set row = row | push({ text: errorMessage | safe }) %}

    {% set tableBodyRows = tableBodyRows | push(row) %}

  {% endif %}
{% endfor %}

{% set tableCaption = "Trainee " + 'record' | pluralise(tableBodyRows.length) + " with errors (" + tableBodyRows.length + ")" %}
{% set tableCaptionClasses =  "govuk-visually-hidden" %}
{% set tableHeadRow = 
  [
    {
      text: "Row",
      classes: "app-table__column-5"
    },
    {
      text: "Trainee",
      classes: "app-table__column-25"
    },
    {
      text: "Error"
    }
  ]
%}

{# These counts are used by include "_includes/bulk-action/upload-summary.html  #}
{% set errorCount = tableBodyRows.length %}
{% set unchangedCount = unchangedTrainees %}
{% set updatedCount = updatedTrainees %}

{% set bulkRoute = "addDetails" %}

{% set pageHeading = "Errors in your trainee records file" %}

{% block content %}

  {% include "_includes/bulk-action/errors-found.html" %}

{% endblock %}


