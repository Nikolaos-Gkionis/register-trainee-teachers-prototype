{% extends "_templates/_page.html" %}

{% set pageHeading = "Review pending updates to trainee records" %}
{% set navActive = 'bulk' %}

{% set currentTrainees = data.filteredRecords | filterByStatus("Draft", true) | filterByActive %}

{% set traineesThatCanBeUpdated = currentTrainees | filterByIncomplete | filterOutEarlyYears | filterByStatus(["Deferred", "Withdrawn"], true) %}

{% set headRow = [
    {
      text: "Trainee",
      classes: "app-table__column-25"
    },
    {
      text: "Trainee start date",
      classes: "app-table__column-25"
    },
    {
      text: "First placement school",
      classes: "app-table__column-25"
    },
    {
      text: "Second placement school",
      classes: "app-table__column-25"
    }
  ]
%}

{% set updatedTraineeRows = [] %}

{% for trainee in traineesThatCanBeUpdated %}

  {% set completion = 0 %}
  {% set traineeInfo = trainee.personalDetails.shortName + '<br> <span style="color:  #505a5f">' + trainee.reference + '</span>' %}

  {% set row = [
    { text: traineeInfo | safe }
  ] %}
  
  {% set commencementDate %}
    {% if trainee.trainingDetails.commencementDate %}
      {{ trainee.trainingDetails.commencementDate | govukDate }}
      {% set completion = completion + 1 %}
    {% elseif (range(0, 10) | random) > 2 %}
      {% set fakeDate = [range(1, 29) | random | makeNumberTwoDigits, range(9, 11) | random | makeNumberTwoDigits, data.years.defaultCourseYear] %}
      {{ fakeDate | govukDate }}
      {% set completion = completion + 1 %}
    {% else -%}
      –
    {%- endif %}
  {% endset %}

  {% set row = row | push({ text: commencementDate | safe })%}


  {% for item in trainee.placement.items %}
    {% set placementContent %}
      {{ item.school.schoolName }}<br>
      <span style="color: #505a5f">URN: {{ item.school.urn }}</span>
    {% endset %}
    {% set completion = completion + 1 %}
    {% set row = row | push({ text: placementContent | safe }) %}
  {% endfor %}

  {% for items in row %}
    {% if row.length != headRow.length %}
      {% set row = row | push({ text: "–" }) %}
    {% endif %}
  {% endfor %}

  {% if completion > 0 %}
    {% set updatedTraineeRows = updatedTraineeRows | push(row) %}
  {% endif %}

{% endfor %}

{# These counts are used by include "_includes/bulk-action/upload-summary.html  #}
{% set errorCount = 0 %}
{% set unchangedCount = traineesThatCanBeUpdated.length - updatedTraineeRows.length %}
{% set updatedCount = updatedTraineeRows.length %}

{% block content %}

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds-from-desktop">
      <h1 class="govuk-heading-l">
        <span class="govuk-caption-xl">{{ data.signedInProviders | andSeparate }}</span>
        {# {{ pageHeading }} #}
        Review pending updates to <span class="app-nowrap">trainee records</span>
      </h1>
      {% if data.bulk.addDetailsFixErrors == "Yes, fix errors now" or data.bulk.addDetailsFixErrors == "Yes, fix error now" %}
        {% include "_includes/bulk-action/upload-summary.html" %}
      {% endif %}
    </div>
  </div>
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      {{ govukTable({
        caption: "Pending updates to trainee records (" + updatedTraineeRows.length + ")",
        captionClasses: "govuk-table__caption--m",
        head: headRow,
        rows: updatedTraineeRows
      }) }}
    </div>
  </div>
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds-from-desktop">
      <p class="govuk-body govuk-!-margin-bottom-7">
        <a href="fix-pending-updates">Make changes to your pending updates</a>
      </p>
      <form action="/bulk-action/add-details/confirmation" method="post" novalidate>
      {# put cancle below #}
          {{ govukButton({
            text: "Confirm updates to records"
          }) }}
          <p class="govuk-body"><a href="#" class="govuk-link">Cancel bulk changes to records</a></p>
      </form>
    </div>
  </div>

{% endblock %}


